var Scene,__bind=function(e,t){return function(){return e.apply(t,arguments)}};Scene=function(){function e(e){this.update=__bind(this.update,this);var t,n=this;this.WIDTH=e.width!==void 0?e.width:500;this.HEIGHT=e.height!==void 0?e.height:500;this.renderer=new THREE.WebGLRenderer({preserveDrawingBuffer:true,antialias:true});this.renderer.setSize(e.width,e.height);$("#container").append(this.renderer.domElement);this.scene=new THREE.Scene;this.camera=new THREE.OrthographicCamera(this.WIDTH/-2,this.WIDTH/2,this.HEIGHT/2,this.HEIGHT/-2,-5e3,5e3);this.frameLength=1e3/30;this.time=0;this.frames=[];this.saveFrames=true;this.gui=new dat.GUI({height:1e3,width:300});this.rotationAmount=1;this.gui.add(this,"rotationAmount",-4,4).step(.05);this.startingLevel=0;this.numLevels=4;this.allCircles=[];t=0;while(t<this.numLevels){this.allCircles[t]=[];t++}this.cameraTarget=new THREE.Vector3;this.cameraTargetStart=new THREE.Vector3;this.cameraTargetLerp=0;this.cameraWidth=this.WIDTH;this.targetCircle=null;this.circleRotationStart=0;this.circleRotationEnd=0;$("#container").on("mousedown",function(e){n.reset();return n.animateIntoCircle(n.allCircles[n.startingLevel+1][0])})}e.prototype.init=function(){var e,t;e=new THREE.CircleGeometry(this.WIDTH/2,100);t=new THREE.MeshBasicMaterial({color:16777215,wireframe:false});this.circle=new THREE.Mesh(e,t);this.createCirclesInCircle(this.circle);this.scene.add(this.circle);this.whiteShield=new THREE.Mesh(new THREE.PlaneGeometry(500,500),new THREE.MeshBasicMaterial({transparent:true,color:16777215}));this.blackShield=new THREE.Mesh(new THREE.PlaneGeometry(500,500),new THREE.MeshBasicMaterial({transparent:true,color:0}));this.scene.add(this.whiteShield);this.scene.add(this.blackShield);this.scene.updateMatrixWorld();this.reset();return this.update()};e.prototype.reset=function(){var e,t,n,r,i,s;this.targetCircle=this.allCircles[this.startingLevel][0];this.cameraTarget=this.getWorldPosition(this.targetCircle);this.cameraWidth=this.targetCircle.geometry.radius*2;this.currentShield=this.startingLevel%2===0?this.whiteShield:this.blackShield;this.targetCircle.add(this.currentShield);this.currentShield.position.z=-.01;this.targetCircle.position.z=.1;t=0;while(t<this.allCircles.length){s=this.allCircles[t];for(n=r=0,i=s.length;r<i;n=++r){e=s[n];e.rotation.z=0;e.material.opacity=t>this.startingLevel+1?0:1}t++}return this.animateIntoCircle(this.allCircles[this.startingLevel+1][0])};e.prototype.animateIntoCircle=function(e){var t,n=this;this.targetCircle=e;this.cameraTargetStart.set(this.cameraTarget.x,this.cameraTarget.y,this.cameraTarget.z);this.cameraTargetLerp=0;this.circleRotationStart=this.targetCircle.rotation.z;this.circleRotationEnd=this.circleRotationStart-Math.PI*this.rotationAmount;this.currentShield=e.level%2===1?this.blackShield:this.whiteShield;this.targetCircle.add(this.currentShield);this.currentShield.material.opacity=0;this.currentShield.position.z=-.01;this.targetCircle.position.z=.1;t=new TWEEN.Tween(this);t.to({cameraWidth:this.targetCircle.geometry.radius*2,cameraTargetLerp:1},1e3);t.easing(TWEEN.Easing.Quadratic.InOut);t.onUpdate(function(){var e,t,r,i,s,o,u,a,f,l,c,h,p;l=n.allCircles[n.targetCircle.level-1];for(t=i=0,u=l.length;i<u;t=++i){e=l[t];e.rotation.z=utils.lerp(n.circleRotationStart,n.circleRotationEnd,n.cameraTargetLerp)}r=new THREE.Vector3;n.targetCircle.parent.parent.updateMatrixWorld();r.getPositionFromMatrix(n.targetCircle.matrixWorld);r.lerp(n.cameraTargetStart,1-n.cameraTargetLerp);n.cameraTarget=r.clone();n.currentShield.material.opacity=n.cameraTargetLerp;c=n.allCircles[n.targetCircle.level];for(t=s=0,a=c.length;s<a;t=++s){e=c[t];e.rotation.z=Math.PI*4/3*n.cameraTargetLerp}h=n.allCircles[n.targetCircle.level+1];p=[];for(t=o=0,f=h.length;o<f;t=++o){e=h[t];p.push(e.material.opacity=n.cameraTargetLerp)}return p});t.onComplete(function(){if(n.targetCircle.level+2<n.numLevels){return n.animateIntoCircle(n.allCircles[n.targetCircle.level+1][0])}else{if(n.saveFrames){n.saveFrames=false;n.saveFramesToZip();$("#download").fadeIn()}return n.reset()}});return t.start(this.time)};e.prototype.createCirclesInCircle=function(e,t){var n,r,i,s,o,u,a,f,l;if(t==null){t=0}u=0;a=3;l=[];while(u<a){o=t%2===1?16777215:0;f=t>this.startingLevel+1?0:1;r=new THREE.CircleGeometry(e.geometry.radius/(1+2/3*Math.sqrt(3)),60);i=new THREE.MeshBasicMaterial({color:o,wireframe:false,transparent:true,opacity:f});s=new THREE.Object3D;n=new THREE.Mesh(r,i);n.position.z=.01;n.position.x=e.geometry.radius-n.geometry.radius;s.rotation.z=u/a*Math.PI*2;s.add(n);e.add(s);n.level=t;this.allCircles[t].push(n);if(t+1<this.numLevels){this.createCirclesInCircle(n,t+1)}l.push(u++)}return l};e.prototype.getWorldPosition=function(e){var t;t=new THREE.Vector3;e.updateMatrixWorld();t.getPositionFromMatrix(e.matrixWorld);return t};e.prototype.saveFramesToZip=function(){var e,t,n,r,i;r=function(e,t,n){n=n||"0";e=e+"";if(e.length>=t){return e}else{return(new Array(t-e.length+1)).join(n)+e}};i=new JSZip;t=i.folder("frames");n=0;while(n<this.frames.length){t.file("frame"+r(n,3,0)+".png",this.frames[n],{base64:true});n++}e=document.getElementById("download");e.download="frames.zip";return e.href=window.URL.createObjectURL(i.generate({type:"blob"}))};e.prototype.update=function(){var e,t,n=this;setTimeout(function(){return requestAnimationFrame(n.update)},this.frameLength);TWEEN.update(this.time);this.time+=this.frameLength;this.circle.children[0].updateMatrixWorld();t=new THREE.Vector3;t.getPositionFromMatrix(this.circle.children[0].children[0].matrixWorld);this.camera.left=this.cameraTarget.x-this.cameraWidth/2;this.camera.right=this.cameraTarget.x+this.cameraWidth/2;this.camera.top=this.cameraTarget.y+this.cameraWidth/2;this.camera.bottom=this.cameraTarget.y-this.cameraWidth/2;this.camera.updateProjectionMatrix();this.renderer.render(this.scene,this.camera);if(this.saveFrames){e=this.renderer.domElement.toDataURL().replace(/^data:image\/(png|jpg);base64,/,"");return this.frames.push(e)}};return e}()